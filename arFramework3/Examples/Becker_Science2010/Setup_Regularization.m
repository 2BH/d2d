% Demo of symmetric penalization of fold-change differences
% See also: Hauber et al., 2022

%% Compilation
arInit
arLoadModel('epo_int_rep_reg');
arLoadModel('epo_binding_reg');
arLoadData('Simu_CL1_Exp1','epo_int_rep_reg');
arLoadData('Simu_CL1_EpoBinding','epo_binding_reg');
arLoadData('Simu_CL2_Exp1','epo_int_rep_reg');
arLoadData('Simu_CL2_EpoBinding','epo_binding_reg');
arLoadData('Simu_CL3_Exp1','epo_int_rep_reg');
arLoadData('Simu_CL3_EpoBinding','epo_binding_reg');
arLoadData('Simu_CL4_Exp1','epo_int_rep_reg');
arLoadData('Simu_CL4_EpoBinding','epo_binding_reg');
arLoadData('Simu_CL5_Exp1','epo_int_rep_reg');
arLoadData('Simu_CL5_EpoBinding','epo_binding_reg');
arMergePlotMulti(1,{'Simu_CL1_Exp1','Simu_CL2_Exp1','Simu_CL3_Exp1','Simu_CL4_Exp1','Simu_CL5_Exp1'},{'CL1','CL2','CL3','CL4','CL5'},'Experiment1')
arMergePlotMulti(2,{'Simu_CL1_EpoBinding','Simu_CL2_EpoBinding','Simu_CL3_EpoBinding','Simu_CL4_EpoBinding','Simu_CL5_EpoBinding'},{'CL1','CL2','CL3','CL4','CL5'},'EpoBinding')
arCompileAll;

arLoadPars('BestFit')
arSetParsPattern('kex',0,0)
arSetPars('kex',-5,0)
arSetParsPattern('isEq',0,0,0)
arSetPars('offset',-5,0)

ar.config.atol = 1e-8;
ar.config.rtol = 1e-8;

%% Data Simulation
% The following parameters are identical to those used for the simulation
% study in Fig. 3 from Hauber et al. 2022
simuPars = [3.129526e+00 -1.035969e+00 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 -1.921247e+00 -2.895286e+00 -1.256020e+00 -3.238069e+00 -1.093201e+00 -8.200363e-01 -1.795540e+00 -5.000000e+00 4.000000e-01 0 -5.000000e-01 0 0 0 0 0 0 4.000000e-01 0 0 0 0 0 0 -5.000000e-01 0 0 0 -5.000000e-01 0 0 0 0 -5.000000e-01 0 0 0 0 0 0 0 0 5.000000e-01 0 -8.849440e-03 -1.400701e+00 -2.074558e+00 -1.256882e+00 -1.320326e+00];
ar.p = simuPars;
arSetParsPattern('isEq',0,0,0)
arSimuData([],[],[],1)

%% Model Fitting
ar.p(ar.qFit == 1) = -1;
arFitLHS(100);

%% Regularization
arActivateDiffPen({'relto_CL2_init_Epo','relto_CL3_init_Epo','isEq_CL2_CL3_init_Epo';...
    'relto_CL2_init_Epo','relto_CL4_init_Epo','isEq_CL2_CL4_init_Epo';...
    'relto_CL3_init_Epo','relto_CL4_init_Epo','isEq_CL3_CL4_init_Epo';...
    'relto_CL2_init_Epo','relto_CL5_init_Epo','isEq_CL2_CL5_init_Epo';...
    'relto_CL3_init_Epo','relto_CL5_init_Epo','isEq_CL3_CL5_init_Epo';...
    'relto_CL4_init_Epo','relto_CL5_init_Epo','isEq_CL4_CL5_init_Epo';...
    'relto_CL2_init_EpoR_rel','relto_CL3_init_EpoR_rel','isEq_CL2_CL3_init_EpoR_rel';...
    'relto_CL2_init_EpoR_rel','relto_CL4_init_EpoR_rel','isEq_CL2_CL4_init_EpoR_rel';...
    'relto_CL3_init_EpoR_rel','relto_CL4_init_EpoR_rel','isEq_CL3_CL4_init_EpoR_rel';...
    'relto_CL2_init_EpoR_rel','relto_CL5_init_EpoR_rel','isEq_CL2_CL5_init_EpoR_rel';...
    'relto_CL3_init_EpoR_rel','relto_CL5_init_EpoR_rel','isEq_CL3_CL5_init_EpoR_rel';...
    'relto_CL4_init_EpoR_rel','relto_CL5_init_EpoR_rel','isEq_CL4_CL5_init_EpoR_rel';...
    'relto_CL2_kde','relto_CL3_kde','isEq_CL2_CL3_kde';...
    'relto_CL2_kde','relto_CL4_kde','isEq_CL2_CL4_kde';...
    'relto_CL3_kde','relto_CL4_kde','isEq_CL3_CL4_kde';...
    'relto_CL2_kde','relto_CL5_kde','isEq_CL2_CL5_kde';...
    'relto_CL3_kde','relto_CL5_kde','isEq_CL3_CL5_kde';...
    'relto_CL4_kde','relto_CL5_kde','isEq_CL4_CL5_kde';...
    'relto_CL2_kdi','relto_CL3_kdi','isEq_CL2_CL3_kdi';...
    'relto_CL2_kdi','relto_CL4_kdi','isEq_CL2_CL4_kdi';...
    'relto_CL3_kdi','relto_CL4_kdi','isEq_CL3_CL4_kdi';...
    'relto_CL2_kdi','relto_CL5_kdi','isEq_CL2_CL5_kdi';...
    'relto_CL3_kdi','relto_CL5_kdi','isEq_CL3_CL5_kdi';...
    'relto_CL4_kdi','relto_CL5_kdi','isEq_CL4_CL5_kdi';...
    'relto_CL2_ke','relto_CL3_ke','isEq_CL2_CL3_ke';...
    'relto_CL2_ke','relto_CL4_ke','isEq_CL2_CL4_ke';...
    'relto_CL3_ke','relto_CL4_ke','isEq_CL3_CL4_ke';...
    'relto_CL2_ke','relto_CL5_ke','isEq_CL2_CL5_ke';...
    'relto_CL3_ke','relto_CL5_ke','isEq_CL3_CL5_ke';...
    'relto_CL4_ke','relto_CL5_ke','isEq_CL4_CL5_ke';...
    'relto_CL2_koff','relto_CL3_koff','isEq_CL2_CL3_koff';...
    'relto_CL2_koff','relto_CL4_koff','isEq_CL2_CL4_koff';...
    'relto_CL3_koff','relto_CL4_koff','isEq_CL3_CL4_koff';...
    'relto_CL2_koff','relto_CL5_koff','isEq_CL2_CL5_koff';...
    'relto_CL3_koff','relto_CL5_koff','isEq_CL3_CL5_koff';...
    'relto_CL4_koff','relto_CL5_koff','isEq_CL4_CL5_koff';...
    'relto_CL2_kon','relto_CL3_kon','isEq_CL2_CL3_kon';...
    'relto_CL2_kon','relto_CL4_kon','isEq_CL2_CL4_kon';...
    'relto_CL3_kon','relto_CL4_kon','isEq_CL3_CL4_kon';...
    'relto_CL2_kon','relto_CL5_kon','isEq_CL2_CL5_kon';...
    'relto_CL3_kon','relto_CL5_kon','isEq_CL3_CL5_kon';...
    'relto_CL4_kon','relto_CL5_kon','isEq_CL4_CL5_kon';...
    'relto_CL2_kt','relto_CL3_kt','isEq_CL2_CL3_kt';...
    'relto_CL2_kt','relto_CL4_kt','isEq_CL2_CL4_kt';...
    'relto_CL3_kt','relto_CL4_kt','isEq_CL3_CL4_kt';...
    'relto_CL2_kt','relto_CL5_kt','isEq_CL2_CL5_kt';...
    'relto_CL3_kt','relto_CL5_kt','isEq_CL3_CL5_kt';...
    'relto_CL4_kt','relto_CL5_kt','isEq_CL4_CL5_kt';...
    })

q = 0.8;
arRegularize('relto',0,4,'Type','lq','Deform',1-q,'Test','LRT')
arPrint('isEq')